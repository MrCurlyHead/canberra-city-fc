{% extends "base.html" %}
{% block title %}Player Details{% endblock %}
{% block content %}
<div class="player-details-container">
  <ul class="nav nav-tabs schedule-tabs" id="playersTabs" role="tablist">
    {% set active_year = 2026 if current_year() == 2026 else 2025 %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_year == 2025 %}active{% endif %}" id="players-tab-2025" data-year="2025" type="button" role="tab" aria-controls="players-2025" aria-selected="{{ 'true' if active_year == 2025 else 'false' }}">2025</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_year == 2026 %}active{% endif %}" id="players-tab-2026" data-year="2026" type="button" role="tab" aria-controls="players-2026" aria-selected="{{ 'true' if active_year == 2026 else 'false' }}">2026</button>
    </li>
  </ul>

  <!-- Enhanced Header Section -->
  <div class="player-details-header">
    <h1 class="player-details-title">Player Details</h1>
    <span class="player-count-badge">{{ players|length }} REGISTERED PLAYERS</span>
  </div>

  {% if session.logged_in %}
  <form method="post">
  {% endif %}

  <!-- Player Cards Grid (replaces both desktop table and mobile cards) -->
  <div class="player-cards-grid">
    {% for p in players %}
    <div class="player-card">
      <!-- Accent Bar -->
      <div class="player-card-accent"></div>
      
      <!-- Card Content -->
      <div class="player-card-content">
        <!-- Player Name Header -->
        <div class="player-card-header">
          <div class="player-name-wrapper">
            <h2 class="player-name">
              {% if session.logged_in %}
                <input type="text" class="player-name-input" name="name_{{ p.id }}" value="{{ p.name }}">
              {% else %}
                {{ p.name }}
              {% endif %}
            </h2>
          </div>
          <div class="player-number-wrapper">
            {% if session.logged_in %}
              <input type="text" class="player-number-input" name="shirt_{{ p.id }}" value="{{ p.shirt_number or '' }}" placeholder="#" maxlength="3">
            {% elif p.shirt_number %}
              <span class="player-number-badge">{{ p.shirt_number }}</span>
            {% endif %}
          </div>
        </div>

        <!-- Player Details -->
        <div class="player-details-list">
          <div class="player-detail-row">
            <span class="player-detail-label">Preferred Position</span>
            <span class="player-detail-value">
              {% if session.logged_in %}
                <input type="text" class="player-detail-input" name="preferred_position_{{ p.id }}" value="{{ p.preferred_position or '' }}" placeholder="—">
              {% else %}
                {{ p.preferred_position or '—' }}
              {% endif %}
            </span>
          </div>

          <div class="player-detail-row">
            <span class="player-detail-label">Beer Duty Date</span>
            <span class="player-detail-value">
              {% if session.logged_in %}
                <input type="date" class="player-detail-input" name="beer_duty_date_{{ p.id }}" value="{{ p.beer_duty_date|default('') }}">
              {% else %}
                {{ p.beer_duty_date|format_date if p.beer_duty_date else '—' }}
              {% endif %}
            </span>
          </div>

          {% if session.logged_in or p.support_offered %}
          <div class="player-detail-row player-detail-row-full">
            <span class="player-detail-label">Support Offered</span>
            <div class="player-detail-value player-detail-textarea">
              {% if session.logged_in %}
                <textarea class="player-detail-textarea-input" name="support_offered_{{ p.id }}" rows="2" placeholder="—">{{ p.support_offered or '' }}</textarea>
              {% else %}
                {{ p.support_offered or '—' }}
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        {% if session.logged_in %}
        <div class="player-card-actions">
          <a href="{{ url_for('delete_player', player_id=p.id) }}" class="btn btn-danger-soft btn-sm" onclick="return confirm('Delete {{ p.name }}?');">Delete</a>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  {% if session.logged_in %}
    <div class="player-details-actions">
      <button type="submit" class="btn-glow">Save Changes</button>
    </div>
  </form>

  <div class="glass-card mt-4">
    <h4 class="mb-3">Add New Player</h4>
    <form method="post" action="{{ url_for('add_player') }}">
      <div class="mb-3">
        <input type="text" class="form-control" name="new_player_name" placeholder="Full Name" required>
      </div>
      <button type="submit" class="btn-soft">Add Player</button>
    </form>
  </div>
  {% endif %}
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tabKey = 'playersPreferredYear';
    const tabSelector = '#playersTabs [data-year]';
    const storedYear = localStorage.getItem(tabKey);

    if (storedYear) {
      document.querySelectorAll(tabSelector).forEach(btn => btn.classList.remove('active'));
      const trigger = document.querySelector(`${tabSelector}[data-year="${storedYear}"]`);
      if (trigger) {
        trigger.classList.add('active');
        const url = new URL(window.location);
        url.searchParams.set('players_year', storedYear);
        window.history.replaceState({}, '', url);
      }
    }

    document.querySelectorAll(tabSelector).forEach(btn => {
      btn.addEventListener('click', event => {
        const year = event.currentTarget.getAttribute('data-year');
        if (year) {
          localStorage.setItem(tabKey, year);
          document.querySelectorAll(tabSelector).forEach(b => b.classList.remove('active'));
          event.currentTarget.classList.add('active');
          const url = new URL(window.location);
          url.searchParams.set('players_year', year);
          window.history.replaceState({}, '', url);
        }
      });
    });
  });
</script>
{% endblock %}
