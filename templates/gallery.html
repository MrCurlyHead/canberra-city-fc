{% extends "base.html" %}
{% block title %}Gallery{% endblock %}
{% block content %}
<div class="container gallery-page">
  <div class="section-heading">
    <h1>Gallery</h1>
  </div>

  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {% if active_year == 2025 %}active{% endif %}" href="{{ url_for('gallery', year=2025) }}">2025</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_year == 2026 %}active{% endif %}" href="{{ url_for('gallery', year=2026) }}">2026</a>
    </li>
  </ul>

  {% if session.logged_in %}
  <div class="glass-card light">
    <form method="post" action="{{ url_for('gallery_upload') }}" enctype="multipart/form-data" class="row g-2 align-items-center">
      <div class="col-sm-5">
        <input class="form-control" type="file" name="file" accept=".png,.jpg,.jpeg,.gif,.webp,.mp4,.mov,.avi" required>
      </div>
      <div class="col-sm-3">
        <select name="year" class="form-select">
          <option value="2025" {% if active_year == 2025 %}selected{% endif %}>2025</option>
          <option value="2026" {% if active_year == 2026 %}selected{% endif %}>2026</option>
        </select>
      </div>
      <div class="col-sm-3">
        <button class="btn-glow" type="submit">Upload</button>
      </div>
    </form>
  </div>
  {% endif %}

  {% if media_files %}
  <div id="masonry" class="masonry">
    {% set images = [] %}
    {% for item in media_files %}
      {% set name = item.name %}
      {% set ext = name.rsplit('.', 1)[1].lower() %}
      {% if ext in ['png','jpg','jpeg','gif','webp'] %}
      <div class="masonry-item">
        {% if session.logged_in %}
        <form class="gallery-delete-form" action="{{ url_for('gallery_delete') }}" method="post" onsubmit="return confirm('Delete this photo?');">
          <input type="hidden" name="year" value="{{ active_year }}">
          <input type="hidden" name="name" value="{{ name }}">
          <button type="submit" class="gallery-delete-btn" title="Delete">&times;</button>
        </form>
        {% endif %}
        <img
          class="masonry-img"
          src="{{ url_for('gallery_media', year=active_year, filename=name) }}?v={{ item.v }}"
          data-src="{{ url_for('gallery_media', year=active_year, filename=name) }}?v={{ item.v }}"
          alt=""
          loading="lazy">
      </div>
      {% endif %}
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">No media found for {{ active_year }} yet.</div>
  {% endif %}
</div>

<!-- Lightbox modal -->
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog">
  <div class="lightbox-backdrop"></div>
  <div class="lightbox-content" role="document">
    <button id="lightbox-close" class="lightbox-close" aria-label="Close">&times;</button>
    <button id="lightbox-prev" class="lightbox-nav lightbox-prev" aria-label="Previous">&#10094;</button>
    <img id="lightbox-img" class="lightbox-img" alt="">
    <button id="lightbox-next" class="lightbox-nav lightbox-next" aria-label="Next">&#10095;</button>
  </div>
  <div class="lightbox-scrim"></div>
  <div class="lightbox-dimmer"></div>
  <div class="lightbox-interceptor"></div>
  <div class="lightbox-blur"></div>
  <div class="lightbox-overlay"></div>
  <div class="lightbox-mask"></div>
</div>

<script>
  (function() {
    const body = document.body;
    const container = document.getElementById('masonry');
    const images = Array.from(container ? container.querySelectorAll('.masonry-img') : []);

    // Lightbox elements
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const btnClose = document.getElementById('lightbox-close');
    const btnPrev = document.getElementById('lightbox-prev');
    const btnNext = document.getElementById('lightbox-next');
    const backdrop = lightbox ? lightbox.querySelector('.lightbox-backdrop') : null;

    let currentIndex = -1;

    function openLightbox(index) {
      currentIndex = index;
      if (!images[currentIndex]) return;
      const src = images[currentIndex].getAttribute('data-src') || images[currentIndex].src;
      lightboxImg.src = src;
      lightbox.setAttribute('aria-hidden', 'false');
      lightbox.classList.add('open');
      body.style.overflow = 'hidden';
      // Preload neighbors
      const prevIdx = (currentIndex - 1 + images.length) % images.length;
      const nextIdx = (currentIndex + 1) % images.length;
      [prevIdx, nextIdx].forEach(i => {
        const preload = new Image();
        preload.src = images[i].getAttribute('data-src') || images[i].src;
      });
    }

    function closeLightbox() {
      lightbox.classList.remove('open');
      lightbox.setAttribute('aria-hidden', 'true');
      lightboxImg.src = '';
      currentIndex = -1;
      body.style.overflow = '';
    }

    function showNext(delta) {
      if (currentIndex < 0) return;
      currentIndex = (currentIndex + delta + images.length) % images.length;
      const src = images[currentIndex].getAttribute('data-src') || images[currentIndex].src;
      lightboxImg.src = src;
    }

    // Click bindings
    images.forEach((img, idx) => {
      img.addEventListener('click', () => openLightbox(idx));
    });

    if (btnClose) btnClose.addEventListener('click', closeLightbox);
    if (btnPrev) btnPrev.addEventListener('click', () => showNext(-1));
    if (btnNext) btnNext.addEventListener('click', () => showNext(1));
    if (backdrop) backdrop.addEventListener('click', closeLightbox);

    // Close on ESC, navigate with arrows
    window.addEventListener('keydown', (e) => {
      if (lightbox.getAttribute('aria-hidden') === 'true') return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showNext(-1);
      if (e.key === 'ArrowRight') showNext(1);
    });
  })();
</script>
{% endblock %}


