<!-- templates/edit_results.html -->
{% extends "base.html" %}
{% block title %}Edit Result{% endblock %}

{% block content %}
<div class="glass-card light">
  <div class="section-heading">
    <h1 class="mb-0">Edit Match Result</h1>
    <span class="badge-soft">{{ event.date|format_date }} â€¢ vs {{ event.opponent }}</span>
  </div>

  {% set goal_scorers = event.result.get('goal_scorers', []) %}
  {% set assists = event.result.get('assists', []) %}
  {% set cards = event.result.get('cards', {}) %}
  {% set yellow_cards = cards.get('yellow', []) %}
  {% set red_cards = cards.get('red', []) %}

  <form method="post">
    <div class="row g-4">
      <div class="col-md-6">
        <label class="form-label">Home Score</label>
        <input type="number" class="form-control" name="home_score" value="{{ event.result.home_score }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Away Score</label>
        <input type="number" class="form-control" name="away_score" value="{{ event.result.away_score }}">
      </div>
    </div>

    <hr class="my-4">
    <h4 class="mb-3">Goal Scorers</h4>
    <div class="mb-3">
      <label class="form-label">Number of Goal Scorers</label>
      <select class="form-select" name="num_goal_scorers" id="num_goal_scorers">
        {% for i in range(0, 11) %}
          <option value="{{ i }}" {% if goal_scorers|length == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    {% for i in range(1, 11) %}
    {% set entry = goal_scorers[i-1] if goal_scorers|length >= i else None %}
    <div class="row g-3 mb-2 goal-group" id="goal_group_{{ i }}" style="display: none;">
      <div class="col-md-8">
        <select class="form-select" name="goal_scorer_{{ i }}">
          <option value="">-- Select Player --</option>
          {% for player in players %}
            <option value="{{ player.name }}" {% if entry and entry.player == player.name %}selected{% endif %}>{{ player.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <select class="form-select" name="goal_count_{{ i }}">
          <option value="">Goals</option>
          {% for g in range(1, 10) %}
            <option value="{{ g }}" {% if entry and entry.goals == g %}selected{% endif %}>{{ g }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    {% endfor %}

    <hr class="my-4">
    <h4 class="mb-3">Assists</h4>
    <div class="mb-3">
      <label class="form-label">Number of Assist Providers</label>
      <select class="form-select" name="num_assists" id="num_assists">
        {% for i in range(0, 11) %}
          <option value="{{ i }}" {% if assists|length == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    {% for i in range(1, 11) %}
    {% set entry = assists[i-1] if assists|length >= i else None %}
    <div class="row g-3 mb-2 assist-group" id="assist_group_{{ i }}" style="display: none;">
      <div class="col-md-8">
        <select class="form-select" name="assist_player_{{ i }}">
          <option value="">-- Select Player --</option>
          {% for player in players %}
            <option value="{{ player.name }}" {% if entry and entry.player == player.name %}selected{% endif %}>{{ player.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <select class="form-select" name="assist_count_{{ i }}">
          <option value="">Assists</option>
          {% for a in range(1, 10) %}
            <option value="{{ a }}" {% if entry and entry.assists == a %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    {% endfor %}

    <hr class="my-4">
    <h4 class="mb-3">Yellow Cards</h4>
    <div class="mb-3">
      <label class="form-label">Number of Yellow Cards</label>
      <select class="form-select" name="num_yellow_cards" id="num_yellow_cards">
        {% for i in range(0, 11) %}
          <option value="{{ i }}" {% if yellow_cards|length == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    {% for i in range(1, 11) %}
    {% set entry = yellow_cards[i-1] if yellow_cards|length >= i else None %}
    <div class="mb-2 yellow-group" id="yellow_group_{{ i }}" style="display: none;">
      <select class="form-select" name="yellow_card_{{ i }}">
        <option value="">-- Select Player --</option>
        {% for player in players %}
          <option value="{{ player.name }}" {% if entry and entry == player.name %}selected{% endif %}>{{ player.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% endfor %}

    <hr class="my-4">
    <h4 class="mb-3">Red Cards</h4>
    <div class="mb-3">
      <label class="form-label">Number of Red Cards</label>
      <select class="form-select" name="num_red_cards" id="num_red_cards">
        {% for i in range(0, 11) %}
          <option value="{{ i }}" {% if red_cards|length == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    {% for i in range(1, 11) %}
    {% set entry = red_cards[i-1] if red_cards|length >= i else None %}
    <div class="mb-2 red-group" id="red_group_{{ i }}" style="display: none;">
      <select class="form-select" name="red_card_{{ i }}">
        <option value="">-- Select Player --</option>
        {% for player in players %}
          <option value="{{ player.name }}" {% if entry and entry == player.name %}selected{% endif %}>{{ player.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% endfor %}

    <div class="d-flex justify-content-between align-items-center mt-4">
      <a href="{{ url_for('results') }}" class="btn btn-soft">Cancel</a>
      <button type="submit" class="btn-glow">Save Result</button>
    </div>
  </form>
</div>

<form method="post" action="{{ url_for('delete_result', event_id=event.id) }}" class="text-end mt-3">
  <button type="submit" class="btn btn-danger-soft" onclick="return confirm('Are you sure you want to delete this match result?');">Delete Result</button>
</form>

<script>
  function toggleFields(prefix, count) {
    for (let i = 1; i <= 10; i++) {
      const group = document.getElementById(`${prefix}_group_${i}`);
      if (group) {
        group.style.display = i <= count ? 'flex' : 'none';
      }
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const goalSelect   = document.getElementById("num_goal_scorers");
    const assistSelect = document.getElementById("num_assists");
    const yellowSelect = document.getElementById("num_yellow_cards");
    const redSelect    = document.getElementById("num_red_cards");

    const configs = [
      { select: goalSelect, prefix: "goal" },
      { select: assistSelect, prefix: "assist" },
      { select: yellowSelect, prefix: "yellow" },
      { select: redSelect, prefix: "red" }
    ];

    configs.forEach(({ select, prefix }) => {
      if (!select) return;

      select.addEventListener("change", function () {
        toggleFields(prefix, parseInt(this.value || "0"));
      });

      toggleFields(prefix, parseInt(select.value || "0"));
    });
  });
</script>

{% endblock %}
